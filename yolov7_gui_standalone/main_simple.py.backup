"""
YOLOv7 Training GUI - Main Entry Point
ë©”ì¸ ì‹¤í–‰ íŒŒì¼
"""

import sys
import os
import traceback
from pathlib import Path

# ê²½ë¡œ ì„¤ì •
current_dir = Path(__file__).parent
sys.path.insert(0, str(current_dir / "src"))

def get_resource_path(relative_path):
    """EXEì—ì„œ ë¦¬ì†ŒìŠ¤ íŒŒì¼ ê²½ë¡œ ì°¾ê¸°"""
    try:
        # PyInstallerë¡œ ë¹Œë“œëœ ê²½ìš°
        base_path = sys._MEIPASS
    except Exception:
        # ê°œë°œ í™˜ê²½
        base_path = os.path.abspath(".")
    
    return os.path.join(base_path, relative_path)

def check_requirements():
    """í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸"""
    required_packages = ['torch', 'torchvision', 'cv2', 'numpy', 'matplotlib', 'yaml']
    missing_packages = []
    
    for package in required_packages:
        try:
            if package == 'cv2':
                import cv2
            elif package == 'yaml':
                import yaml
            else:
                __import__(package)
        except ImportError:
            missing_packages.append(package)
    
    if missing_packages:
        print("âŒ ë‹¤ìŒ íŒ¨í‚¤ì§€ë“¤ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:")
        for pkg in missing_packages:
            print(f"   - {pkg}")
        print("\nğŸ“¦ ì„¤ì¹˜ ëª…ë ¹ì–´:")
        print("pip install torch torchvision opencv-python numpy matplotlib PyYAML")
        return False
    
    return True

def create_simple_ui():
    """ê°„ë‹¨í•œ UI íŒŒì¼ ìƒì„±"""
    
    ui_dir = Path("src/ui")
    ui_dir.mkdir(exist_ok=True)
    
    # ê°„ë‹¨í•œ main_window.py ìƒì„±
    simple_ui = '''"""
YOLOv7 Training GUI - Simple Main Window
"""

import tkinter as tk
from tkinter import ttk, filedialog, messagebox
from pathlib import Path

class MainWindow:
    """ê°„ë‹¨í•œ ë©”ì¸ GUI ìœˆë„ìš°"""
    
    def __init__(self, root, trainer, config_manager, model_manager):
        self.root = root
        self.trainer = trainer
        self.config_manager = config_manager
        self.model_manager = model_manager
        
        # UI ë³€ìˆ˜ë“¤
        self.dataset_path_var = tk.StringVar()
        self.epochs_var = tk.IntVar(value=100)
        self.batch_size_var = tk.IntVar(value=8)
        self.device_var = tk.StringVar(value="cpu")
        self.experiment_name_var = tk.StringVar(value="gui_test")
        
        # UI ìƒì„±
        self.create_ui()
        self.setup_callbacks()
        
    def create_ui(self):
        """UI ìƒì„±"""
        self.root.title("ğŸš€ YOLOv7 Training GUI")
        self.root.geometry("800x600")
        self.root.configure(bg='#f0f0f0')
        
        # ë©”ì¸ í”„ë ˆì„
        main_frame = ttk.Frame(self.root, padding="20")
        main_frame.pack(fill='both', expand=True)
        
        # ì œëª©
        title_label = ttk.Label(main_frame, text="ğŸš€ YOLOv7 Training GUI", 
                               font=('Arial', 20, 'bold'))
        title_label.pack(pady=20)
        
        # ì„¤ì • í”„ë ˆì„
        settings_frame = ttk.LabelFrame(main_frame, text="âš™ï¸ í›ˆë ¨ ì„¤ì •", padding="15")
        settings_frame.pack(fill='x', pady=10)
        
        # ë°ì´í„°ì…‹ ê²½ë¡œ
        ttk.Label(settings_frame, text="Dataset Path (YAML):").pack(anchor='w')
        dataset_frame = ttk.Frame(settings_frame)
        dataset_frame.pack(fill='x', pady=5)
        
        ttk.Entry(dataset_frame, textvariable=self.dataset_path_var, width=60).pack(side='left', fill='x', expand=True)
        ttk.Button(dataset_frame, text="Browse", command=self.browse_dataset).pack(side='right', padx=(5, 0))
        
        # í›ˆë ¨ íŒŒë¼ë¯¸í„°
        params_frame = ttk.Frame(settings_frame)
        params_frame.pack(fill='x', pady=10)
        
        # Epochs
        ttk.Label(params_frame, text="Epochs:").grid(row=0, column=0, sticky='w', padx=(0, 10))
        ttk.Scale(params_frame, from_=1, to=500, variable=self.epochs_var, orient='horizontal', length=200).grid(row=0, column=1, sticky='ew')
        self.epochs_label = ttk.Label(params_frame, text="100")
        self.epochs_label.grid(row=0, column=2, padx=(5, 0))
        
        # Batch Size
        ttk.Label(params_frame, text="Batch Size:").grid(row=1, column=0, sticky='w', padx=(0, 10), pady=(5, 0))
        ttk.Scale(params_frame, from_=1, to=32, variable=self.batch_size_var, orient='horizontal', length=200).grid(row=1, column=1, sticky='ew', pady=(5, 0))
        self.batch_label = ttk.Label(params_frame, text="8")
        self.batch_label.grid(row=1, column=2, padx=(5, 0), pady=(5, 0))
        
        # Device
        ttk.Label(params_frame, text="Device:").grid(row=2, column=0, sticky='w', padx=(0, 10), pady=(5, 0))
        device_combo = ttk.Combobox(params_frame, textvariable=self.device_var, values=["cpu", "0", "0,1"], width=20)
        device_combo.grid(row=2, column=1, sticky='w', pady=(5, 0))
        
        # Experiment Name
        ttk.Label(params_frame, text="Experiment:").grid(row=3, column=0, sticky='w', padx=(0, 10), pady=(5, 0))
        ttk.Entry(params_frame, textvariable=self.experiment_name_var, width=25).grid(row=3, column=1, sticky='w', pady=(5, 0))
        
        params_frame.grid_columnconfigure(1, weight=1)
        
        # ë¡œê·¸ í”„ë ˆì„
        log_frame = ttk.LabelFrame(main_frame, text="ğŸ“ Training Log", padding="10")
        log_frame.pack(fill='both', expand=True, pady=10)
        
        # ë¡œê·¸ í…ìŠ¤íŠ¸
        log_container = ttk.Frame(log_frame)
        log_container.pack(fill='both', expand=True)
        
        self.log_text = tk.Text(log_container, bg='#2c3e50', fg='#ecf0f1', 
                               font=('Courier', 10), height=15, wrap=tk.WORD)
        log_scrollbar = ttk.Scrollbar(log_container, orient="vertical", command=self.log_text.yview)
        self.log_text.configure(yscrollcommand=log_scrollbar.set)
        
        self.log_text.pack(side="left", fill="both", expand=True)
        log_scrollbar.pack(side="right", fill="y")
        
        # ë²„íŠ¼ í”„ë ˆì„
        button_frame = ttk.Frame(main_frame)
        button_frame.pack(fill='x', pady=20)
        
        # ë²„íŠ¼ë“¤
        self.start_btn = ttk.Button(button_frame, text="ğŸš€ Start Training", command=self.start_training)
        self.start_btn.pack(side='left', padx=5)
        
        self.stop_btn = ttk.Button(button_frame, text="â¹ï¸ Stop", command=self.stop_training, state='disabled')
        self.stop_btn.pack(side='left', padx=5)
        
        ttk.Button(button_frame, text="ğŸ”„ Reset", command=self.reset_settings).pack(side='left', padx=5)
        
        ttk.Button(button_frame, text="ğŸ§ª Test Connection", command=self.test_connection).pack(side='right', padx=5)
        
        # ì´ˆê¸° ë¡œê·¸ ë©”ì‹œì§€
        self.add_log_entry("ğŸ’¡ YOLOv7 GUI ì¤€ë¹„ ì™„ë£Œ!")
        self.add_log_entry(f"ğŸ“ YOLOv7 ê²½ë¡œ: {self.trainer.yolo_original_dir}")
        self.add_log_entry("ğŸ¯ ë°ì´í„°ì…‹ì„ ì„ íƒí•˜ê³  Start Trainingì„ í´ë¦­í•˜ì„¸ìš”.")
        
        # Scale ë³€ê²½ ì‹œ ë¼ë²¨ ì—…ë°ì´íŠ¸
        self.epochs_var.trace('w', lambda *args: self.epochs_label.config(text=str(self.epochs_var.get())))
        self.batch_size_var.trace('w', lambda *args: self.batch_label.config(text=str(self.batch_size_var.get())))
    
    def setup_callbacks(self):
        """íŠ¸ë ˆì´ë„ˆ ì½œë°± ì„¤ì •"""
        self.trainer.register_callback('training_started', self.on_training_started)
        self.trainer.register_callback('log_update', self.on_log_update)
        self.trainer.register_callback('training_complete', self.on_training_complete)
        self.trainer.register_callback('error', self.on_error)
    
    def browse_dataset(self):
        """ë°ì´í„°ì…‹ íŒŒì¼ ì„ íƒ"""
        filename = filedialog.askopenfilename(
            title="Select Dataset YAML File",
            filetypes=[("YAML files", "*.yaml *.yml"), ("All files", "*.*")]
        )
        if filename:
            self.dataset_path_var.set(filename)
            self.add_log_entry(f"ğŸ“‚ ë°ì´í„°ì…‹ ì„ íƒ: {Path(filename).name}")
    
    def start_training(self):
        """í›ˆë ¨ ì‹œì‘"""
        if not self.validate_settings():
            return
        
        # UI ì„¤ì • ìˆ˜ì§‘
        ui_config = {
            'dataset_path': self.dataset_path_var.get(),
            'model_config': 'cfg/training/yolov7.yaml',
            'epochs': self.epochs_var.get(),
            'batch_size': self.batch_size_var.get(),
            'image_size': 640,
            'device': self.device_var.get(),
            'experiment_name': self.experiment_name_var.get(),
            'weights_path': '',
            'workers': 4,
            'learning_rate': 0.01
        }
        
        try:
            # YOLOv7 ì„¤ì •ìœ¼ë¡œ ë³€í™˜
            training_config = self.config_manager.get_training_config(ui_config)
            
            # í›ˆë ¨ ì‹œì‘
            self.add_log_entry("ğŸš€ í›ˆë ¨ ì‹œì‘ ì¤‘...")
            self.trainer.start_training(training_config)
            
        except Exception as e:
            self.add_log_entry(f"âŒ í›ˆë ¨ ì‹œì‘ ì‹¤íŒ¨: {e}")
            messagebox.showerror("ì˜¤ë¥˜", f"í›ˆë ¨ ì‹œì‘ ì‹¤íŒ¨: {e}")
    
    def stop_training(self):
        """í›ˆë ¨ ì •ì§€"""
        if messagebox.askyesno("í™•ì¸", "í›ˆë ¨ì„ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            self.trainer.stop_training()
            self.add_log_entry("â¹ï¸ í›ˆë ¨ ì •ì§€ë¨")
    
    def reset_settings(self):
        """ì„¤ì • ì´ˆê¸°í™”"""
        self.dataset_path_var.set("")
        self.epochs_var.set(100)
        self.batch_size_var.set(8)
        self.device_var.set("cpu")
        self.experiment_name_var.set("gui_test")
        self.add_log_entry("ğŸ”„ ì„¤ì • ì´ˆê¸°í™”ë¨")
    
    def test_connection(self):
        """ì—°ê²° í…ŒìŠ¤íŠ¸"""
        try:
            test_config = {
                'dataset_path': 'test.yaml',
                'model_config': 'cfg/training/yolov7.yaml',
                'epochs': 1,
                'batch_size': 1,
                'image_size': 640,
                'device': 'cpu',
                'experiment_name': 'test'
            }
            
            yolo_config = self.config_manager.get_training_config(test_config)
            cmd = self.trainer.build_command(yolo_config)
            
            self.add_log_entry("ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!")
            self.add_log_entry(f"ğŸ”§ ëª…ë ¹ì–´ ê¸¸ì´: {len(cmd)} ì¸ì")
            messagebox.showinfo("í…ŒìŠ¤íŠ¸ ì„±ê³µ", "YOLOv7 ì—°ê²°ì´ ì •ìƒì…ë‹ˆë‹¤!")
            
        except Exception as e:
            self.add_log_entry(f"âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
            messagebox.showerror("í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨", f"ì—°ê²° ì˜¤ë¥˜: {e}")
    
    def validate_settings(self):
        """ì„¤ì • ìœ íš¨ì„± ê²€ì‚¬"""
        if not self.dataset_path_var.get():
            messagebox.showerror("ì˜¤ë¥˜", "ë°ì´í„°ì…‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
            return False
        
        dataset_path = Path(self.dataset_path_var.get())
        if not dataset_path.exists():
            messagebox.showerror("ì˜¤ë¥˜", f"ë°ì´í„°ì…‹ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {dataset_path}")
            return False
        
        return True
    
    # ì½œë°± ë©”ì„œë“œë“¤
    def on_training_started(self, data):
        """í›ˆë ¨ ì‹œì‘ ì½œë°±"""
        self.add_log_entry("âœ… í›ˆë ¨ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!")
        self.start_btn.config(state='disabled')
        self.stop_btn.config(state='normal')
    
    def on_log_update(self, data):
        """ë¡œê·¸ ì—…ë°ì´íŠ¸ ì½œë°±"""
        log_line = data.get('line', '')
        if log_line.strip():
            self.root.after(0, self.add_log_entry, log_line.strip())
    
    def on_training_complete(self, data):
        """í›ˆë ¨ ì™„ë£Œ ì½œë°±"""
        success = data.get('success', False)
        if success:
            self.add_log_entry("ğŸ‰ í›ˆë ¨ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        else:
            self.add_log_entry("âŒ í›ˆë ¨ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        
        self.start_btn.config(state='normal')
        self.stop_btn.config(state='disabled')
    
    def on_error(self, data):
        """ì˜¤ë¥˜ ì½œë°±"""
        error_msg = data.get('message', 'Unknown error')
        self.add_log_entry(f"âŒ ì˜¤ë¥˜: {error_msg}")
    
    def add_log_entry(self, message):
        """ë¡œê·¸ ì—”íŠ¸ë¦¬ ì¶”ê°€"""
        from datetime import datetime
        
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_message = f"[{timestamp}] {message}\\n"
        
        # í…ìŠ¤íŠ¸ ìœ„ì ¯ì— ì¶”ê°€
        self.log_text.insert(tk.END, log_message)
        self.log_text.see(tk.END)
        
        # ë¡œê·¸ ê¸¸ì´ ì œí•œ
        lines = self.log_text.get("1.0", tk.END).split('\\n')
        if len(lines) > 500:
            self.log_text.delete("1.0", "100.0")
    
    def show(self):
        """ìœˆë„ìš° í‘œì‹œ"""
        self.root.deiconify()
'''
    
    with open("src/ui/main_window.py", 'w', encoding='utf-8') as f:
        f.write(simple_ui)
    
    print("âœ… ê°„ë‹¨í•œ UI ìƒì„± ì™„ë£Œ!")

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    
    print("ğŸš€ YOLOv7 Training GUI ì‹œì‘...")
    print("=" * 50)
    
    try:
        # í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸
        if not check_requirements():
            input("\\níŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•œ í›„ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...")
            return
        
        print("âœ… ëª¨ë“  í•„ìˆ˜ íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
        
        # UI íŒŒì¼ í™•ì¸ ë° ìƒì„±
        ui_file = Path("src/ui/main_window.py")
        if not ui_file.exists() or ui_file.stat().st_size < 1000:
            print("ğŸ“ UI íŒŒì¼ ìƒì„± ì¤‘...")
            create_simple_ui()
        
        # GUI ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        from app import YOLOv7App
        
        print("ğŸ¯ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì¤‘...")
        app = YOLOv7App()
        
        print("ğŸ¨ GUI ì‹œì‘ ì¤‘...")
        app.run()
        
    except KeyboardInterrupt:
        print("\\nğŸ‘‹ ì‚¬ìš©ìì— ì˜í•´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    except ImportError as e:
        print(f"âŒ ëª¨ë“ˆ ì„í¬íŠ¸ ì˜¤ë¥˜: {e}")
        print("\\nğŸ”§ í•´ê²° ë°©ë²•:")
        print("1. í•„ìš”í•œ íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸")
        print("2. ê°€ìƒí™˜ê²½ì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸")
        print("3. Python ê²½ë¡œê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸")
        
    except Exception as e:
        # ì—ëŸ¬ ë¡œê¹…
        error_log = current_dir / "error.log"
        with open(error_log, "w", encoding='utf-8') as f:
            f.write(f"Error: {str(e)}\\n")
            f.write(traceback.format_exc())
        
        print(f"âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì˜¤ë¥˜: {str(e)}")
        print(f"ğŸ“ ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ê°€ {error_log}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
        
        # ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ì•Œë¦¼
        try:
            import tkinter as tk
            from tkinter import messagebox
            
            root = tk.Tk()
            root.withdraw()
            messagebox.showerror(
                "ì˜¤ë¥˜ ë°œìƒ", 
                f"ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\\n\\n{str(e)}\\n\\nìì„¸í•œ ë‚´ìš©ì€ error.log íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”."
            )
        except:
            print("GUI ì˜¤ë¥˜ ì•Œë¦¼ í‘œì‹œ ì‹¤íŒ¨")
        
        sys.exit(1)

if __name__ == "__main__":
    main()